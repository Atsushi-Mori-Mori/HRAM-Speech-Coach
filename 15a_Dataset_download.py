#　-*- coding: utf-8 -*-
import sys
import os
import re
import struct
import binascii
import numpy as np
from math import floor, ceil
import shutil
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import glob
# -------------------------------------------------------
# pip install -U datasets huggingface_hub pandas numpy pyarrow

import os
from pathlib import Path
import numpy as np
import pandas as pd
from huggingface_hub import login
from datasets import load_dataset

# ===== 設定 =====
REPO = "Amouri28/hram-speech-coach-dataset"  # 例: "atsushi-mouri/hram-speech-coach-dataset"
OUT_ROOT = Path("./csv_recovered")   # 復元先のルートフォルダ
NA_REP = ""                          # NaN をCSVに何で出すか（"" / "NaN" など）

# private の場合のみ必要
if "HUGGINGFACE_HUB_TOKEN" in os.environ:
    login(token=os.environ["HUGGINGFACE_HUB_TOKEN"])

# データセットを取得（train/test/eva すべて）
dsd = load_dataset(REPO, cache_dir="./hf_cache")

# 'ts' を NumPy で受け取りたい（他の列は通常どおり）
for split in dsd.keys():
    dsd[split].set_format(type="numpy", columns=["ts"], output_all_columns=True)

# 復元ループ
for split, ds in dsd.items():
    for rec in ds:
        # 1) 出力パス：id は元の相対パス（例: "train/xxx.csv"）
        out_path = OUT_ROOT / rec["id"]
        out_path.parent.mkdir(parents=True, exist_ok=True)

        # 2) 形を元のサイズに戻す（作成時に保存した orig_rows/cols を利用）
        orig_rows = int(rec.get("orig_rows", 240))
        orig_cols = int(rec.get("orig_cols", 18))

        ts = np.asarray(rec["ts"], dtype=np.float32)
        ts_cut = ts[:orig_rows, :orig_cols]  # パディングを取り除く

        # 3) ヘッダ（columns）も元の列数ぶんだけ使う
        cols = list(rec["columns"])[:orig_cols]
        # 列名が不足していれば空文字で埋める（念のため）
        if len(cols) < orig_cols:
            cols += [""] * (orig_cols - len(cols))

        # 4) DataFrame → CSV へ
        df = pd.DataFrame(ts_cut, columns=cols)
        df.to_csv(out_path, index=False, encoding="utf-8-sig", na_rep=NA_REP)

print(f"✅ 完了: {OUT_ROOT} 配下にCSVを書き出しました。")
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------
# # -------------------------------------------------------

